<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Exclusiones ‚Äì Google Sheets (CSV + WebApp por OT)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
:root{ --dom-blue:#0e4aa8; --ink:#0e2040; }
*{box-sizing:border-box}
body{ font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif; background:linear-gradient(180deg,#eef4ff,#fff); margin:0; color:#1a2333; }

/* Header */
.header{ background:rgba(255,255,255,0.55); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
  padding:14px 24px 10px; box-shadow:0 6px 18px rgba(0,0,0,.06); border-bottom:1px solid rgba(255,255,255,.4); }
.header-title{ font-size:24px; font-weight:800; color:#0e2040; }
.header-sub{ margin-top:2px; color:#4e5d78; font-size:14px; }

/* Controles */
.controls{ margin-top:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.btn{ display:inline-block; padding:8px 18px; border-radius:999px; font-size:13px; border:none; cursor:pointer; }
.btn-blue{ background:#0e4aa8; color:#fff; }
.btn-light{ background:#e8eef7; color:#0e4aa8; }
.btn[disabled]{ opacity:.65; cursor:not-allowed; }

/* Search pill */
.search-pill{ display:flex; align-items:center; gap:8px; background:#fff; border:1px solid #d7e0f5; border-radius:999px;
  height:36px; padding:0 12px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
.search-pill input{ border:none; outline:none; height:100%; font-size:13px; min-width:200px; max-width:320px; }
.search-icon{ width:16px; height:16px; opacity:.55; }

/* Badge √∫ltima actualizaci√≥n */
.badge-ts{ background:#eef3ff; color:#0e3a82; border:1px solid #dbe6ff; padding:6px 10px; border-radius:999px; font-size:12px;
  display:inline-flex; align-items:center; gap:8px; }
.badge-dot{ width:8px; height:8px; border-radius:999px; background:#10b981; }

/* Grupos por OT */
.wrap{ width:92%; margin: 14px auto 0; }
.grupo{ background:rgba(255,255,255,.6); border-radius:18px; padding:10px 14px 14px; backdrop-filter: blur(14px);
  border:1px solid rgba(199,215,243,.6); box-shadow: 0 10px 24px rgba(0,0,0,.06); margin-bottom:14px; }
.grupo summary{ list-style:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between; padding:8px 6px; font-weight:700; color:#0e3a82; }
.grupo summary::-webkit-details-marker { display:none; }
.sum-left{ display:flex; gap:8px; align-items:center; }
.sum-right{ display:flex; gap:10px; align-items:center; }
.badge{ background:#eef3ff; color:#0e3a82; font-weight:700; padding:6px 10px; border-radius:999px; border:1px solid #dbe6ff; }

/* Bot√≥n Postular por OT */
.btn-ot{
  padding:8px 14px; border-radius:999px; border:none; cursor:pointer;
  background:#0e4aa8; color:#fff; font-size:13px; box-shadow:0 4px 12px rgba(14,74,168,.25);
}
.btn-ot:hover{ filter:brightness(.95); }
.btn-ot:disabled,
.btn-ot.disabled{ background:#d9e2f5; color:#6b7893; box-shadow:none; cursor:not-allowed; filter:none; }

/* Items (cards) */
.items{ display:grid; grid-template-columns: repeat(auto-fill, minmax(330px, 1fr)); gap:16px; margin-top:10px; }
.card{ background:#fff; border-radius:18px; padding:14px; box-shadow:0 8px 20px rgba(0,0,0,.07); border-bottom:3px solid #0e4aa8; }
.card label{ font-weight:600; color:#556; display:block; margin:6px 0 6px; }
.card input[readonly]{ background:#eef1f6; height:38px; width:100%; border-radius:12px; border:none; padding:0 12px; -webkit-user-drag:none; }

/* Textarea fijo */
.card textarea{ width:100%; height:64px; min-height:64px; max-height:64px; resize:none; overflow:auto;
  border:1px solid #cbd8ef; border-radius:12px; padding:10px 12px; line-height:1.25; -webkit-user-drag:none; }
.card textarea:focus{ outline:2px solid #0e4aa822; box-shadow: inset 0 0 0 1px #cbd8ef; }

/* Preview fotos */
.preview{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
.preview img{ width:78px; height:78px; border-radius:12px; object-fit:cover; box-shadow:0 4px 12px rgba(0,0,0,.2); }

/* Pie */
.pie{ width:92%; margin: 14px auto 24px; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
.paginacion{ display:flex; gap:6px; flex-wrap:wrap; }
.paginacion button{ padding:8px 12px; border-radius:10px; border:none; background:#0e4aa8; color:#fff; cursor:pointer; }

/* Alertas */
#alerta{ width:92%; margin:8px auto 0; color:#b00020; font-size:13px; display:none; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-title">Exclusiones de Operatividad</div>
  <div class="header-sub">Lee CSV publicado ‚Ä¢ Escribe v√≠a Web App ‚Ä¢ Agrupaci√≥n por <strong>OT</strong></div>

  <div class="controls">
    <button id="btnCargar" class="btn btn-blue" type="button">Cargar / Actualizar</button>
    <button id="btnLimpiar" class="btn btn-light" type="button">Limpiar</button>

    <div class="search-pill" title="Buscar por OT">
      <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20 15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
      </svg>
      <input id="busqueda" type="text" placeholder="Buscar OTs‚Ä¶" autocomplete="off" />
    </div>

    <span class="badge-ts" id="lastUpdate"><span class="badge-dot"></span>√öltima actualizaci√≥n: ‚Äî</span>
  </div>
</div>

<!-- Contenedor -->
<div class="wrap" id="wrapGrupos"></div>

<!-- Pie -->
<div class="pie">
  <div class="info-res" id="infoRes">0 registros</div>
  <div class="paginacion" id="paginacion"></div>
</div>

<div id="alerta"></div>

<script>
/* ======= CONFIG ======= */
// 1) CSV publicado (lectura)
const CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_W27zX-XeuQfxQMSdJ5cyE6ez4BegMGL02fC4DQ1dJc0_LLeW1uUyUFQv2exRy_Uz8kN7H5NOHsnO/pub?gid=0&single=true&output=csv';
// 2) Web App de Apps Script (escritura)
const WEB_APP_URL = 'https://script.google.com/macros/s/TU_DEPLOY_ID/exec'; // üëà pega aqu√≠ tu /exec

/* ======= Estado ======= */
let datos = [];        // dataset editable (en memoria)
let filtrados = [];
let grupos = [];       // [{ clave:'OTxxx', items:[...] }]
let paginaActual = 1;
const porPaginaGrupos = 6;
const $ = sel => document.querySelector(sel);

/* ======= Utils ======= */
function mostrarAlerta(msg){ const el=$('#alerta'); el.textContent=msg; el.style.display='block'; }
function ocultarAlerta(){ const el=$('#alerta'); el.textContent=''; el.style.display='none'; }
function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }
function esc(s){ return (s??"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function cssId(texto){ return btoa(unescape(encodeURIComponent(texto))).replace(/=/g,''); }
function norm(s){ return (s ?? '').toString().trim(); }
function normalizarClave(obj, clave){
  const goal = norm(clave).toLowerCase();
  for(const k of Object.keys(obj)){ if(norm(k).toLowerCase()===goal) return obj[k]; }
  return "";
}
function formatTs(d){ const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0');
  const yyyy=d.getFullYear(), hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0'), ss=String(d.getSeconds()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}:${ss}`; }
function setLastUpdate(dateObj){ const el=$('#lastUpdate'); if(el) el.innerHTML = `<span class="badge-dot"></span>√öltima actualizaci√≥n: ${formatTs(dateObj)}`; }

/* ======= CSV Parser ======= */
function detectarDelimitador(headerLine){ const c=(headerLine.match(/,/g)||[]).length, p=(headerLine.match(/;/g)||[]).length, t=(headerLine.match(/\t/g)||[]).length; return t>c&&t>p?'\t':(p>=c?';':','); }
function parseCSV(text){
  const src=text.replace(/\r\n/g,"\n").replace(/\r/g,"\n"); const lines=src.split("\n");
  if(!lines.length) return []; if(lines[0] && lines[0].charCodeAt(0)===0xFEFF) lines[0]=lines[0].slice(1);
  const sep=detectarDelimitador(lines[0]); const rows=[]; let row=[], cur="", q=false;
  for(let i=0;i<src.length;i++){ const ch=src[i], nx=src[i+1];
    if(ch==='"'){ if(q && nx==='"'){ cur+='"'; i++; } else q=!q; }
    else if(ch===sep && !q){ row.push(cur); cur=""; }
    else if(ch==='\n' && !q){ row.push(cur); rows.push(row); row=[]; cur=""; }
    else cur+=ch; }
  if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
  return rows;
}
function csvAObjetos(text){
  const rows=parseCSV(text); if(!rows.length) return [];
  const headers=rows[0].map(h=>norm(h)); const out=[];
  for(let i=1;i<rows.length;i++){ const arr=rows[i]; if(!arr || arr.every(v=>norm(v)==="")) continue;
    const obj={}; for(let c=0;c<headers.length;c++){ obj[headers[c]]=norm(arr[c] ?? ""); } out.push(obj); }
  return out;
}

/* ======= Lectura: CSV publicado ======= */
async function cargarDesdeCSV(){
  const btn=$('#btnCargar');
  try{
    ocultarAlerta(); btn.disabled=true; btn.textContent='Cargando‚Ä¶';
    const bust=`_=${Date.now()}`; const url=CSV_URL + (CSV_URL.includes('?')?'&':'?') + bust;
    const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status);
    const text=await res.text(); const objetos=csvAObjetos(text);
    datos = objetos.map((r,i)=>({ id:i,
      fecha: normalizarClave(r,"fecha exclusion"),
      ot   : normalizarClave(r,"OT") || normalizarClave(r,"ot"),
      causa: normalizarClave(r,"Causa de exclusion") || normalizarClave(r,"causa de exclusion"),
      fotos: [] })).filter(x=>x.ot);

    filtrados=[...datos]; paginaActual=1; construirGruposPorOT(); render(); setLastUpdate(new Date());
  }catch(err){ console.error(err); mostrarAlerta('No se pudo cargar el CSV. Verifica URL/publicaci√≥n.'); }
  finally{ btn.disabled=false; btn.textContent='Cargar / Actualizar'; }
}

/* ======= B√∫squeda / Grupo ======= */
function aplicarBusqueda(){
  const q=($('#busqueda').value||"").toLowerCase().trim();
  filtrados = q ? datos.filter(d => (d.ot||"").toLowerCase().includes(q)) : [...datos];
  paginaActual=1; construirGruposPorOT(); render();
}
function construirGruposPorOT(){
  const map=new Map();
  for(const r of filtrados){ const k=(r.ot??"").toString().trim()||"‚Äî"; if(!map.has(k)) map.set(k,[]); map.get(k).push(r); }
  grupos=Array.from(map.entries()).map(([k,items])=>({clave:k,items}));
  grupos.sort((a,b)=> a.clave.localeCompare(b.clave,'es',{numeric:true}));
}

/* ======= Estado del bot√≥n por OT ======= */
function isOTCompleta(ot){
  const items=datos.filter(d => (d.ot||"").toString().trim()===ot.toString().trim());
  return items.length>0 && items.every(r => (r.causa||"").toString().trim() !== "");
}
function setBtnOTStateById(btnId, enabled){
  const btn=document.getElementById(btnId); if(!btn) return;
  btn.disabled=!enabled; btn.classList.toggle('disabled', !enabled);
}

/* ======= Render ======= */
function render(){
  const wrap=$('#wrapGrupos'); wrap.innerHTML="";
  const totalGrupos=grupos.length, totalItems=filtrados.length;
  $('#infoRes').textContent=`${totalItems} registros ‚Ä¢ ${totalGrupos} grupos (por OT)`;

  const ini=(paginaActual-1)*porPaginaGrupos, fin=ini+porPaginaGrupos, gruposPagina=grupos.slice(ini,fin);

  for(const g of gruposPagina){
    const otClave=g.clave; const det=document.createElement('details'); det.className="grupo"; // colapsado por defecto
    det.innerHTML=`
      <summary>
        <div class="sum-left">OT: <strong>${esc(otClave)}</strong></div>
        <div class="sum-right">
          <span class="badge">${g.items.length} registro${g.items.length!==1?'s':''}</span>
          <button id="btn_ot_${cssId(otClave)}" class="btn-ot" data-ot="${esc(otClave)}">Postular exclusiones</button>
        </div>
      </summary>
      <div class="items" id="items_${cssId(otClave)}"></div>`;
    wrap.appendChild(det);

    // Estado inicial del bot√≥n
    setBtnOTStateById(`btn_ot_${cssId(otClave)}`, isOTCompleta(otClave));

    const cont=det.querySelector(`#items_${cssId(otClave)}`);
    for(const item of g.items){
      const card=document.createElement('div'); card.className="card";
      card.innerHTML=`
        <label>Fecha</label><input value="${esc(item.fecha)}" readonly draggable="false">
        <label>OT</label><input value="${esc(item.ot)}" readonly draggable="false">
        <label style="margin-top:10px;">Causa</label>
        <textarea id="causa_${item.id}" draggable="false" placeholder="Motivo de exclusi√≥n‚Ä¶">${esc(item.causa||'')}</textarea>
        <label style="margin-top:10px;">Fotos</label>
        <input type="file" id="foto_${item.id}" multiple accept="image/*">
        <div class="preview" id="preview_${item.id}"></div>`;
      cont.appendChild(card);

      // Causa -> actualiza estado del bot√≥n OT
      card.querySelector(`#causa_${item.id}`).addEventListener('input', e=>{
        item.causa=e.target.value; const ref=datos.find(x=>x.id===item.id); if(ref) ref.causa=item.causa;
        setBtnOTStateById(`btn_ot_${cssId(otClave)}`, isOTCompleta(otClave));
      });

      // Fotos (local, no se suben)
      const prev=card.querySelector(`#preview_${item.id}`);
      card.querySelector(`#foto_${item.id}`).addEventListener('change', e=>{
        const files=Array.from(e.target.files||[]); item.fotos=files; const ref=datos.find(x=>x.id===item.id); if(ref) ref.fotos=files;
        prev.innerHTML=""; for(const f of files){ const img=document.createElement('img'); img.src=URL.createObjectURL(f); prev.appendChild(img); }
      });
    }
  }
  renderPaginacion(totalGrupos);
}
function renderPaginacion(totalGrupos){
  const cont=$('#paginacion'); cont.innerHTML=""; const total=Math.max(1, Math.ceil(totalGrupos/porPaginaGrupos));
  for(let i=1;i<=total;i++){ const b=document.createElement('button'); b.textContent=i; if(i===paginaActual) b.style.opacity=.85;
    b.onclick=()=>{ paginaActual=i; render(); }; cont.appendChild(b); }
}

/* ======= Escritura: POST ‚Üí Web App (por OT) ======= */
async function postularPorOT(ot){
  const btn = document.getElementById(`btn_ot_${cssId(ot)}`);
  const items = datos.filter(d => (d.ot||"").toString().trim() === ot.toString().trim());
  if(!items.length){ alert(`No hay registros para la OT ${ot}`); return; }
  if(!isOTCompleta(ot)){ alert('Faltan causas en esta OT. Compl√©talas para habilitar el env√≠o.'); return; }

  // payload ligero (solo causa/fecha)
  const registros = items.map(r => ({ fecha: r.fecha, causa: r.causa }));

  try{
    btn.disabled = true; btn.textContent = 'Enviando‚Ä¶';
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ action:'postular_ot', ot, registros })
    });
    const j = await res.json();
    if(!res.ok || !j.ok) throw new Error(j.error || ('HTTP ' + res.status));

    alert(`OT ${ot}: guardada correctamente. Actualizados: ${j.updated||0}, nuevos: ${j.appended||0}`);
    // Nota: la lectura sigue siendo por CSV publicado (puede tardar unos segundos en reflejarse).
    // Si quieres ver el cambio al instante, podr√≠amos leer tambi√©n con GET del Web App.
  }catch(err){
    console.error(err);
    alert('Error al guardar esta OT. Revisa consola para detalles.');
  }finally{
    // Restaura el estado del bot√≥n respecto al llenado
    btn.textContent = 'Postular exclusiones';
    setBtnOTStateById(`btn_ot_${cssId(ot)}`, isOTCompleta(ot));
  }
}

/* ======= Delegaci√≥n de clic ======= */
$('#wrapGrupos').addEventListener('click', (e)=>{
  const btn = e.target.closest('.btn-ot'); if(!btn) return;
  e.preventDefault(); e.stopPropagation();
  const ot = btn.getAttribute('data-ot') || ''; if(ot) postularPorOT(ot);
});

/* ======= Acciones de UI ======= */
$('#btnCargar').addEventListener('click', cargarDesdeCSV);
$('#btnLimpiar').addEventListener('click', ()=>{
  $('#busqueda').value=''; filtrados=[...datos]; paginaActual=1; construirGruposPorOT(); render();
});
$('#busqueda').addEventListener('input', debounce(aplicarBusqueda, 250));

/* ======= Arranque ======= */
cargarDesdeCSV();
</script>
</body>
</html>