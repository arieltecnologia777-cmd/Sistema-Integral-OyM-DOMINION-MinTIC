<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <!-- ðŸ”’ Guard de sesiÃ³n -->
  <script>
    (function(){
      try{
        if(!sessionStorage.getItem('auth_ok')){
          window.location.replace('login.html');
        }
      }catch(e){
        window.location.replace('login.html');
      }
    })();
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hoja de vida Centros Digitales</title>
  <meta name="description" content="Hoja de vida Centros Digitales">
  <style>
    :root{
      --bg:#0c0f1e; --bg-2:#0e1328; --card:#151a33; --text:#eef3fb; --muted:#9fb0c9;
      --line:#273356; --primary:#6ee7ff; --primary-600:#3ecff0; --accent:#ffd166;
      --ok:#2dd4bf; --warn:#f6c344; --danger:#ff6b6b; --chip:#1e294a; --input:#0f1530;
      --shadow: 0 20px 40px rgba(0,0,0,.35); --radius:16px;
      --glass: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      --grad: radial-gradient(1200px 600px at 10% -10%, #2f66ff22, transparent 60%),
              radial-gradient(1000px 500px at 100% 0%, #00e2ff1a, transparent 60%),
              linear-gradient(180deg, #0b0f22 0%, #0b0f2200 35%);
    }
    [data-theme="light"]{
      --bg:#f7f9fc; --bg-2:#eef3fb; --card:#ffffff; --text:#0e1628; --muted:#55637a;
      --line:#d9e2f2; --primary:#2563eb; --primary-600:#1d4ed8; --accent:#b45309;
      --ok:#059669; --warn:#d97706; --danger:#dc2626; --chip:#e7eefc; --input:#f0f4ff;
      --shadow: 0 12px 28px rgba(15,23,42,.12);
      --glass: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.75));
      --grad: radial-gradient(1200px 600px at 10% -10%, #a5b4fc40, transparent 60%),
              radial-gradient(1000px 500px at 100% 0%, #93c5fd33, transparent 60%),
              linear-gradient(180deg, #eef2ff 0%, #eef2ff00 35%);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;}
    a{color:var(--primary);text-decoration:none}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    .sr{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}

    .hero{position:relative; overflow:hidden; background: var(--grad); border-bottom:1px solid var(--line);}
    .halo{position:absolute; inset:-10% -10% auto -10%; height:320px;
      background: radial-gradient(400px 180px at 30% 60%, #77f3ff25, transparent),
                  radial-gradient(500px 220px at 60% 40%, #a6ffdd20, transparent);
      filter: blur(18px); pointer-events:none;}
    header.hero .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding-top:8px;}
    .brand{display:flex; align-items:center; gap:12px;}
    .brand .logo{width:44px;height:44px;border-radius:10px; background:var(--glass); border:1px solid var(--line);
      display:grid;place-items:center; box-shadow:var(--shadow);}
    .brand .logo svg{opacity:.9}
    .brand .titles h1{margin:0; font-size:clamp(22px,2.5vw,30px); letter-spacing:.2px}
    .brand .titles p{margin:2px 0 0 0; color:var(--muted); font-size:14px}

    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .btn{appearance:none; border:none; border-radius:12px; padding:10px 14px;
      background:var(--primary); color:white; font-weight:700; cursor:pointer;
      box-shadow: var(--shadow); transition: transform .06s ease, filter .2s ease, background .2s ease; font-size:14px;}
    .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
    .btn-secondary{ background:transparent; color:var(--text); border:1px solid var(--line); }

    .toolbar{margin-top:16px; padding:12px; border:1px solid var(--line); border-radius:var(--radius);
      background:var(--glass); display:grid; gap:12px; grid-template-columns: repeat(5, minmax(160px,1fr));}
    @media (max-width:1000px){ .toolbar{grid-template-columns: 1fr 1fr; grid-auto-rows:auto} }
    .info{display:flex; flex-direction:column; gap:6px;}
    .info label{font-size:12px; color:var(--muted);}
    .info input{all:unset; background:var(--input); border:1px solid var(--line); border-radius:12px;
      padding:10px 12px; color:var(--text); font-size:14px;}

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 2px 0}
    .chip{background:var(--chip); color:#cfe7ff; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line);}
    [data-theme="light"] .chip{ background:#e7eefc; color:#1f2b44; border-color:#c6d4f7; }

    .kpis{display:grid; gap:14px; grid-template-columns:repeat(3,1fr); margin-top:14px}
    @media (max-width:900px){ .kpis{grid-template-columns:1fr} }
    .kpi{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px; position:relative; overflow:hidden;}
    .kpi .mini{position:absolute; right:14px; top:14px; opacity:.2}
    .kpi h4{margin:0; font-size:13px; color:var(--muted); text-transform:uppercase}
    .kpi .val{font-size:clamp(24px,3vw,32px); font-weight:900; margin-top:6px}
    .kpi .bar{height:8px; background:linear-gradient(90deg, var(--ok), var(--primary)); border-radius:8px; margin-top:10px; width:0; transition:width .6s ease}

    .summary{display:flex; justify-content:space-between; align-items:center; margin:16px 0; color:var(--muted); font-size:14px}
    .grid{display:grid; gap:14px; grid-template-columns:repeat(3, 1fr)}
    @media (max-width:1100px){ .grid{grid-template-columns:repeat(2, 1fr)} }
    @media (max-width:700px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px;
      box-shadow: var(--shadow); cursor:pointer; transition: transform .08s ease, border .2s ease, box-shadow .2s ease;
      position:relative; overflow:hidden;}
    .card:hover{transform:translateY(-2px); border-color:#3a4e76; box-shadow: 0 16px 38px rgba(0,0,0,.30)}
    .card h3{margin:0 0 8px 0; font-size:16px}
    .meta{display:flex; flex-wrap:wrap; gap:8px; color:var(--muted); font-size:12px}
    .badge{background:#1f2b44; border:1px solid var(--line); padding:3px 8px; border-radius:999px; color:#cfe7ff}
    [data-theme="light"] .badge{background:#eef3ff; color:#1f2b44; border-color:#cfdaf7}
    .state{font-weight:800}
    .state.ok{color:var(--ok)} .state.warn{color:var(--warn)} .state.down{color:var(--danger)}
    .statusbar{height:6px; border-radius:6px; background:linear-gradient(90deg, var(--ok), var(--primary)); position:absolute; left:14px; right:14px; bottom:12px; opacity:.7}

    .drawer{position:fixed; right:16px; bottom:16px; width:min(520px, 92vw); max-height:82vh; overflow:auto;
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow: var(--shadow); display:none; z-index:40;}
    .drawer header{position:sticky; top:0; background:linear-gradient(180deg, #14182a, #14182a00); padding:14px; border-bottom:1px solid var(--line)}
    [data-theme="light"] .drawer header{background:linear-gradient(180deg, #f8fafc, #f8fafc00)}
    .drawer .tabs{display:flex; gap:8px; margin-top:8px}
    .drawer .tab{background:transparent; border:1px solid var(--line); padding:6px 10px; border-radius:10px; cursor:pointer; color:var(--text)}
    .drawer .tab.active{background:var(--input)}
    .drawer .content{padding:14px}
    .kv{display:grid; grid-template-columns: 1fr 1.2fr; gap:10px}
    .kv .k{color:var(--muted); font-size:12px}
    .kv .v{font-size:14px}
    .drawer .close{position:absolute; right:12px; top:12px}

    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50;}
    .modal{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px; width:min(620px, 92vw); box-shadow: var(--shadow);}
    .modal h2{margin:0 0 6px 0}
    .modal .row{display:flex; gap:10px; align-items:center}
    .modal input{all:unset; background:var(--input); border:1px solid var(--line); border-radius:10px; padding:12px 14px; flex:1}
    .modal .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}

    footer{border-top:1px solid var(--line); margin-top:18px}
    .hidden{display:none !important}
    @keyframes rise { from{transform:translateY(6px); opacity:0} to{transform:translateY(0); opacity:1} }
    .card{animation: rise .25s ease both}
  </style>
</head>
<body>
  <section class="hero">
    <div class="halo"></div>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo" title="Logo">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3l7 4v10l-7 4-7-4V7l7-4Z" stroke="currentColor" stroke-width="1.6"/>
              <circle cx="12" cy="12" r="2.8" fill="currentColor" />
            </svg>
          </div>
          <div class="titles">
            <h1>Hoja de vida Centros Digitales</h1>
            <p>Consulta, filtra y visualiza el detalle de cada Centro Digital</p>
          </div>
        </div>

        <div class="actions">
          <button id="btnIngresar" class="btn">Ingresar ID/CD</button>
          <button id="btnLimpiar" class="btn btn-secondary" title="Limpiar campos">Limpiar</button>
          <button id="btnRefrescar" class="btn btn-secondary" title="Volver a cargar el dataset">Actualizar</button>
          <button id="btnTheme" class="btn btn-secondary" title="Cambiar tema">Tema: Oscuro</button>
        </div>
      </div>

      <div class="toolbar" id="toolbar-specific">
        <div class="info"><label for="fldDep">Departamento</label><input id="fldDep" placeholder="â€”" readonly></div>
        <div class="info"><label for="fldMun">Municipio</label><input id="fldMun" placeholder="â€”" readonly></div>
        <div class="info"><label for="fldIE">IE</label><input id="fldIE" placeholder="â€”" readonly></div>
        <div class="info"><label for="fldSede">Sede</label><input id="fldSede" placeholder="â€”" readonly></div>
        <div class="info"><label for="fldProy">Proyecto</label><input id="fldProy" placeholder="â€”" readonly></div>
      </div>

      <div class="chips">
        <span class="chip">KPIs automÃ¡ticos</span>
        <span class="chip">CSV Ã³ JSON</span>
        <span class="chip">BÃºsqueda sin acentos</span>
        <span class="chip">Detalle con tabs</span>
        <span class="chip">Tema claro/oscuro</span>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="mini"><svg width="42" height="42" viewBox="0 0 24 24" fill="none"><path d="M4 12h4v8H4v-8Zm6-6h4v14h-4V6Zm6 3h4v11h-4V9Z" fill="currentColor"/></svg></div>
          <h4>Total centros</h4>
          <div id="kpiTotal" class="val">â€”</div>
          <div id="barTotal" class="bar" style="background:linear-gradient(90deg, var(--primary), var(--accent))"></div>
        </div>
        <div class="kpi">
          <div class="mini"><svg width="42" height="42" viewBox="0 0 24 24" fill="none"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 14h-2v-2h2v2Zm0-4h-2V6h2v6Z" fill="currentColor"/></svg></div>
          <h4>Operativos</h4>
          <div id="kpiOk" class="val" style="color:var(--ok)">â€”</div>
          <div id="barOk" class="bar"></div>
        </div>
        <div class="kpi">
          <div class="mini"><svg width="42" height="42" viewBox="0 0 24 24" fill="none"><path d="M12 3l9 16H3L12 3Z" fill="currentColor"/></svg></div>
          <h4>No operativos</h4>
          <div id="kpiDown" class="val" style="color:var(--danger)">â€”</div>
          <div id="barDown" class="bar" style="background:linear-gradient(90deg, var(--danger), #ff9aa2)"></div>
        </div>
      </div>
    </div>
  </section>

  <main class="wrap">
    <div class="summary">
      <div id="resumen">Cargando datosâ€¦</div>
      <div id="fuente" class="hidden"></div>
    </div>
    <div id="grid" class="grid" aria-live="polite"></div>
    <div style="display:flex; justify-content:center; margin:16px 0;">
      <button id="btnMas" class="btn btn-secondary hidden">Mostrar mÃ¡s</button>
    </div>
  </main>

  <aside class="drawer" id="drawer" aria-live="polite">
    <header>
      <h3 id="drawer-title">Detalle del Centro</h3>
      <div class="tabs">
        <button class="tab active" data-tab="resumen">Resumen</button>
        <button class="tab" data-tab="datos">Datos</button>
      </div>
      <button class="btn btn-secondary close" id="btnCloseDrawer">Cerrar</button>
    </header>
    <div class="content" id="tab-resumen"><div class="kv" id="kv-resumen"></div></div>
    <div class="content hidden" id="tab-datos"><div class="kv" id="kv-datos"></div></div>
  </aside>

  <div class="modal-backdrop" id="backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal">
      <header>
        <h2 id="modal-title">Buscar Centro por ID / CÃ³digo</h2>
        <p style="margin:6px 0 0 0; color:var(--muted)">Escribe el <b>ID</b> o <b>cÃ³digo</b> del Centro Digital (ej.: CD1234)</p>
      </header>
      <div class="row" style="margin-top:12px">
        <input id="inpId" placeholder="ID / CÃ³digo del Centro">
        <button class="btn" id="btnBuscarId">Buscar</button>
      </div>
      <div class="actions">
        <button class="btn btn-secondary" id="btnCancelar">Cancelar</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="wrap" style="font-size:12px;color:var(--muted)">
      <p>Fuente configurable (CSV/JSON). Actualiza la constante <code>DATA_URL</code>. Â© <span id="year"></span></p>
    </div>
  </footer>

<script>
/* ========= CONFIG ========= */
/* Tu Google Sheet publicado (opciÃ³n alternativa): */
const SHEET_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaTszHaU4PLm00tAvMRpAUnz1C8xzrcLi-CYSNbqkVGpX-BNKMIJiyuJIqoY5CAdEjMFmqHj-sgNAb/pub?gid=0&single=true&output=csv';

/* Probaremos directo y luego proxys CORS en cascada */
const CORS_PROXIES = [
  (u)=> `https://cors.isomorphic-git.org/${u}`,
  (u)=> `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  (u)=> `https://thingproxy.freeboard.io/fetch/${u}`
];

/* DATA_URL lÃ³gico (se usa solo para mostrar fuente) */
const DATA_URL = SHEET_CSV_URL;
/* ========================== */

const state = {
  raw: [], items: [], headers: [], headerMap: {},
  page: 0, pageSize: 30, lastFilter: null,
  theme: (localStorage.getItem('hv_theme') || 'dark'),
  keys: {
    id: ['id','cd','codigo','codigo_centro','centro_id','centroid','id_centro','codigo_cd'],
    nombre: ['nombre','centro','sede','institucion','razon_social'],
    depto: ['departamento','depto','dpto'],
    mun: ['municipio','mpio','ciudad','localidad'],
    operador: ['operador','operadora','proveedor'],
    estado: ['estado','estatus','situacion'],
    ie: ['ie','institucion_educativa','instituciÃ³n_educativa','institucion','razon_social','nombre_ie'],
    sedeDet: ['sede','nombre_sede','sede_ie'],
    proyecto: ['proyecto','programa','contrato','proyecto_cd']
  }
};
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const normalize = s => (s ?? '').toString().trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
const toKey = s => normalize(s).replace(/[^\w]+/g,'_').replace(/^_+|_+$/g,'');
function safeOn(id, ev, fn){ const el = document.getElementById(id); if(el) el.addEventListener(ev, fn); }
function guessKey(obj, cands){
  for(const k of Object.keys(obj)){ if(cands.includes(toKey(k))) return k; }
  for(const cand of cands){ for(const k of Object.keys(obj)){ if(toKey(k)===cand) return k; } }
  return null;
}

/* ===== CSV parser robusto ===== */
function parseCSV(text){
  const rows=[]; let row=[]; let cur=''; let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(c=='"'){ if(inQuotes && text[i+1]=='"'){ cur+='"'; i++; } else inQuotes=!inQuotes; }
    else if(c==',' && !inQuotes){ row.push(cur); cur=''; }
    else if((c=='\n'||c=='\r') && !inQuotes){ if(cur.length||row.length){ row.push(cur); rows.push(row); } cur=''; row=[]; if(c=='\r'&&text[i+1]=='\n') i++; }
    else{ cur+=c; }
  }
  if(cur.length||row.length){ row.push(cur); rows.push(row); }
  const headers = rows.shift()?.map(h => (h??'').toString().trim()) ?? [];
  const objs = rows.filter(r => r.some(v => (v??'').toString().trim()!==''))
    .map(r => { const o={}; headers.forEach((h,idx)=>o[h]=(r[idx]??'').toString()); return o; });
  return { headers, rows: objs };
}

/* ===== Fetch con reintentos (directo + proxys) ===== */
async function fetchWithFallbacks(url){
  const tries = [ url, ...CORS_PROXIES.map(f => f(url)) ];
  let lastErr = null;
  for(const candidate of tries){
    try{
      const res = await fetch(candidate, { cache:'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status} en ${candidate}`);
      const txt = await res.text();
      if(!txt || !txt.trim()) throw new Error(`Respuesta vacÃ­a en ${candidate}`);
      return { text: txt, used: candidate };
    }catch(err){
      lastErr = err;
      // continÃºa probando siguiente proxy
    }
  }
  throw lastErr || new Error('No se pudo obtener el CSV de ninguna fuente/proxy.');
}

async function loadData(){
  const srcParam = new URLSearchParams(location.search).get('src');
  const url = srcParam || SHEET_CSV_URL;

  const resumen = $('#resumen'); const fuente = $('#fuente');
  fuente.textContent = 'Fuente: ' + (srcParam || DATA_URL);
  fuente.classList.remove('hidden');

  try{
    resumen.textContent = 'Cargando datosâ€¦';
    const { text: txt, used } = await fetchWithFallbacks(url);
    // Opcional: mostrar quÃ© ruta se usÃ³ (debug)
    console.debug('Dataset cargado vÃ­a:', used);

    let items=[], headers=[];
    if((srcParam||DATA_URL).toLowerCase().endsWith('.json') || txt.trim().startsWith('[')){
      const arr = JSON.parse(txt);
      if(!Array.isArray(arr)) throw new Error('El JSON debe ser un arreglo de objetos.');
      items = arr; headers = Object.keys(arr[0]||{});
    }else{
      const {headers: h, rows} = parseCSV(txt);
      headers=h; items=rows;
    }

    const headerMap={}; headers.forEach(h => headerMap[toKey(h)] = h);
    state.raw = items; state.headers=headers; state.headerMap=headerMap;
    state.items = items.map(o => { const oo={}; headers.forEach(h => oo[h]=(o[h]??'').toString().trim()); return oo; });

    state.page=0; applyFilters();
  }catch(err){
    resumen.innerHTML = `<span style="color:var(--danger)">No se pudo cargar el dataset:</span><br>${(err && err.message) || err}`;
    $('#grid').innerHTML = ''; setKPIs(0,0,0);
  }finally{
    delete state.forceRefresh;
  }
}

/* ===== Render / KPIs ===== */
function applyFilters(){
  const q = '';
  const sample = state.items[0] || {};
  const colId = guessKey(sample, state.keys.id.map(toKey));
  const colNombre = guessKey(sample, state.keys.nombre.map(toKey));
  const colDep = guessKey(sample, state.keys.depto.map(toKey));
  const colMun = guessKey(sample, state.keys.mun.map(toKey));
  const colOpe = guessKey(sample, state.keys.operador.map(toKey));
  const colEst = guessKey(sample, state.keys.estado.map(toKey));

  let results = state.items.filter(o => {
    if(q){
      const hay=[o[colId],o[colNombre],o[colMun],o[colDep],o[colOpe]].filter(Boolean).some(v=>normalize(v).includes(q));
      if(!hay) return false;
    }
    return true;
  });

  state.lastFilter = {q};
  state.page = 0;
  renderResults(results, { colId, colNombre, colDep, colMun, colOpe, colEst });
  refreshKPIs(results, { colEst });
}

function renderResults(results, cols){
  const grid = $('#grid'); const resumen = $('#resumen');
  if(!results.length){
    resumen.textContent = 'Sin resultados. Ajusta la fuente o busca por ID/CD.';
    grid.innerHTML = ''; $('#btnMas')?.classList.add('hidden'); return;
  }
  resumen.textContent = `${results.length.toLocaleString('es-CO')} resultados`;
  const end = Math.min(results.length, (state.page+1) * state.pageSize);
  const slice = results.slice(0, end);

  grid.innerHTML = slice.map((o, i) => {
    const nombre = o[cols.colNombre] || '(sin nombre)';
    const id = o[cols.colId] || ''; const dep = o[cols.colDep] || '';
    const mun = o[cols.colMun] || ''; const ope = o[cols.colOpe] || '';
    const est = o[cols.colEst] || '';
    const estClass = /ok|activo|operativo|operativa|en servicio|funciona/i.test(est) ? 'ok' :
                     /baja|inactivo|caido|caÃ­do|fuera|no operativo/i.test(est) ? 'down' : est ? 'warn' : '';
    const hue = (i*37)%360;
    return `
      <article class="card" data-id="${encodeURIComponent(id)}" title="Ver detalle">
        <div style="position:absolute; inset:0; pointer-events:none; opacity:.08; background: radial-gradient(120px 60px at 80% -10%, hsl(${hue} 90% 60% / .9), transparent 70%);"></div>
        <h3>${nombre}</h3>
        <div class="meta" style="margin-bottom:10px">
          ${id ? `<span class="badge">ID: ${id}</span>`:''}
          ${mun ? `<span class="badge">${mun}</span>`:''}
          ${dep ? `<span class="badge">${dep}</span>`:''}
          ${ope ? `<span class="badge">Operador: ${ope}</span>`:''}
          ${est ? `<span class="badge state ${estClass}">${est}</span>`:''}
        </div>
        <div class="statusbar"></div>
      </article>
    `;
  }).join('');

  const btnMas = $('#btnMas');
  if(end < results.length){
    btnMas?.classList.remove('hidden');
    if(btnMas) btnMas.onclick = () => { state.page++; renderResults(results, cols); };
  } else { btnMas?.classList.add('hidden'); }

  $$('#grid .card').forEach(el => {
    el.addEventListener('click', () => {
      const id = decodeURIComponent(el.getAttribute('data-id') || '');
      let item = null;
      if(id){ item = results.find(r => (r[cols.colId]||'') === id) || null; }
      if(!item) item = results.find(r => true);
      showDetail(item, cols);
    });
  });
}

function setKPIs(total, ok, down){
  $('#kpiTotal').textContent = total.toLocaleString('es-CO');
  $('#kpiOk').textContent = ok.toLocaleString('es-CO');
  $('#kpiDown').textContent = down.toLocaleString('es-CO');
  const pctOk = total ? Math.round((ok/total)*100) : 0;
  const pctDown = total ? Math.round((down/total)*100) : 0;
  $('#barTotal').style.width = '100%';
  $('#barOk').style.width = pctOk+'%';
  $('#barDown').style.width = pctDown+'%';
}
function refreshKPIs(results, cols){
  const total = results.length; let ok=0, down=0;
  results.forEach(o => {
    const est = (o[cols.colEst] || '').toString();
    if(/ok|activo|operativo|operativa|en servicio|funciona/i.test(est)) ok++;
    else if(/baja|inactivo|caido|caÃ­do|fuera|no operativo/i.test(est)) down++;
  });
  setKPIs(total, ok, down);
}

/* ===== Drawer & detalle ===== */
function showDetail(item, cols){
  if(!item) return;
  const drawer = $('#drawer');
  $('#drawer-title').textContent = item[ cols.colNombre ] || 'Detalle del Centro';
  const kvResumen = $('#kv-resumen'); const kvDatos = $('#kv-datos');
  kvResumen.innerHTML = ''; kvDatos.innerHTML = '';

  [['ID / CÃ³digo', cols.colId], ['Nombre', cols.colNombre], ['Departamento', cols.colDep],
   ['Municipio', cols.colMun], ['Operador', cols.colOpe], ['Estado', cols.colEst]]
  .forEach(([label, key]) => {
    if(!key) return; const v = item[key];
    if(v!=null && v.toString().trim()!==''){
      kvResumen.insertAdjacentHTML('beforeend', `<div class="k">${label}</div><div class="v">${v}</div>`);
    }
  });

  state.headers.forEach(h => {
    const v = item[h];
    if(v !== undefined && (v ?? '').toString().trim() !== ''){
      kvDatos.insertAdjacentHTML('beforeend', `<div class="k">${h}</div><div class="v">${v}</div>`);
    }
  });

  $$('.drawer .tab').forEach(btn => btn.classList.remove('active'));
  document.querySelector('.drawer .tab[data-tab="resumen"]').classList.add('active');
  $('#tab-resumen').classList.remove('hidden'); $('#tab-datos').classList.add('hidden');

  drawer.style.display = 'block';
  fillSpecificFields(item);
}
function closeDetail(){ $('#drawer').style.display = 'none'; }
function activateTab(tabName){
  const btn = document.querySelector(`.drawer .tab[data-tab="${tabName}"]`);
  if(!btn) return;
  $$('.drawer .tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  $('#tab-resumen').classList.toggle('hidden', tabName!=='resumen');
  $('#tab-datos').classList.toggle('hidden', tabName!=='datos');
}
function fillSpecificFields(item){
  const sample = state.items[0] || {};
  const colDep = guessKey(sample, state.keys.depto.map(toKey));
  const colMun = guessKey(sample, state.keys.mun.map(toKey));
  const colIE  = guessKey(sample, state.keys.ie.map(toKey));
  const colSede = guessKey(sample, state.keys.sedeDet.map(toKey));
  const colProy = guessKey(sample, state.keys.proyecto.map(toKey));
  $('#fldDep').value  = (item?.[colDep] ?? '') || 'â€”';
  $('#fldMun').value  = (item?.[colMun] ?? '') || 'â€”';
  $('#fldIE').value   = (item?.[colIE]  ?? '') || 'â€”';
  $('#fldSede').value = (item?.[colSede]?? '') || 'â€”';
  $('#fldProy').value = (item?.[colProy]?? '') || 'â€”';
}

/* ===== Modal buscar por ID ===== */
function openModal(){ const bd=$('#backdrop'); if(bd){ bd.style.display='flex'; setTimeout(()=> $('#inpId')?.focus(), 60); } }
function closeModal(){ const bd=$('#backdrop'); if(bd){ bd.style.display='none'; } const inp=$('#inpId'); if(inp) inp.value=''; }
function searchById(){
  const val = ($('#inpId')?.value || '').trim(); if(!val) return;
  const sample = state.items[0] || {};
  const colId = guessKey(sample, state.keys.id.map(toKey));
  if(!colId){ alert('No se detectÃ³ columna de ID/CÃ³digo en el dataset.'); return; }
  const target = state.items.find(o => normalize(o[colId]) === normalize(val));
  if(!target){ alert('No se encontrÃ³ un Centro con ese ID/CÃ³digo.'); return; }
  closeModal();

  const cols = {
    colId,
    colNombre: guessKey(sample, state.keys.nombre.map(toKey)),
    colDep: guessKey(sample, state.keys.depto.map(toKey)),
    colMun: guessKey(sample, state.keys.mun.map(toKey)),
    colOpe: guessKey(sample, state.keys.operador.map(toKey)),
    colEst: guessKey(sample, state.keys.estado.map(toKey))
  };

  const results = [target];
  state.page = 0;
  renderResults(results, cols);
  refreshKPIs(results, { colEst: cols.colEst });
  showDetail(target, cols);
  activateTab('datos');
}

/* ===== Tema & Init ===== */
function applyTheme(){
  document.documentElement.setAttribute('data-theme', state.theme);
  const btn = $('#btnTheme'); if(btn) btn.textContent = 'Tema: ' + (state.theme==='dark' ? 'Oscuro' : 'Claro');
}
function toggleTheme(){ state.theme = (state.theme==='dark' ? 'light' : 'dark'); localStorage.setItem('hv_theme', state.theme); applyTheme(); }

function init(){
  const yrEl = document.getElementById('year'); if(yrEl) yrEl.textContent = new Date().getFullYear();
  safeOn('btnIngresar','click', openModal);
  safeOn('btnLimpiar','click', () => {
    ['#fldDep','#fldMun','#fldIE','#fldSede','#fldProy'].forEach(id => { const el=$(id); if(el) el.value=''; });
    closeDetail(); applyFilters();
  });
  safeOn('btnRefrescar','click', () => { state.forceRefresh=true; loadData(); });
  safeOn('btnTheme','click', toggleTheme);
  safeOn('btnBuscarId','click', searchById);
  safeOn('btnCancelar','click', closeModal);
  safeOn('btnCloseDrawer','click', closeDetail);
  const backdrop = document.getElementById('backdrop');
  if(backdrop){ backdrop.addEventListener('click', e => { if(e.target && e.target.id==='backdrop') closeModal(); }); }
  document.addEventListener('keydown', e => { if(e.key==='Escape'){ closeModal(); closeDetail(); } });

  applyTheme();
  loadData().catch(err => console.error(err));
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>