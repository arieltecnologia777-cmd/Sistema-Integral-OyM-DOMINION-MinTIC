<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Exclusiones – Google Sheets (CSV + WebApp por OT)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- Sello de build para diagnosticar versiones renderizadas -->
<meta name="x-build" content="<?= cacheBuster ?>">
<style>
:root{ --dom-blue:#0e4aa8; --ink:#0e2040; }
*{box-sizing:border-box}
body{ font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif; background:linear-gradient(180deg,#eef4ff,#fff); margin:0; color:#1a2333; }
/* Header */
.header{ background:rgba(255,255,255,0.55); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
 padding:14px 24px 10px; box-shadow:0 6px 18px rgba(0,0,0,.06); border-bottom:1px solid rgba(255,255,255,.4); }
.header-title{ font-size:24px; font-weight:800; color:#0e2040; }
.header-sub{ margin-top:2px; color:#4e5d78; font-size:14px; }
/* Controles */
.controls{ margin-top:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.btn{ display:inline-block; padding:8px 18px; border-radius:999px; font-size:13px; border:none; cursor:pointer; }
.btn-blue{ background:#0e4aa8; color:#fff; }
.btn-light{ background:#e8eef7; color:#0e4aa8; }
.btn[disabled]{ opacity:.65; cursor:not-allowed; }
/* Search pill */
.search-pill{ display:flex; align-items:center; gap:8px; background:#fff; border:1px solid #d7e0f5; border-radius:999px;
 height:36px; padding:0 12px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
.search-pill input{ border:none; outline:none; height:100%; font-size:13px; min-width:200px; max-width:320px; }
.search-icon{ width:16px; height:16px; opacity:.55; }
/* Badge última actualización */
.badge-ts{ background:#eef3ff; color:#0e3a82; border:1px solid #dbe6ff; padding:6px 10px; border-radius:999px; font-size:12px;
 display:inline-flex; align-items:center; gap:8px; }
.badge-dot{ width:8px; height:8px; border-radius:999px; background:#10b981; }
/* Grupos por OT */
.wrap{ width:92%; margin: 14px auto 0; }
.grupo{ background:rgba(255,255,255,.6); border-radius:18px; padding:10px 14px 14px; backdrop-filter: blur(14px);
 border:1px solid rgba(199,215,243,.6); box-shadow: 0 10px 24px rgba(0,0,0,.06); margin-bottom:14px; }
.grupo summary{ list-style:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between; padding:8px 6px; font-weight:700; color:#0e3a82; }
.grupo summary::-webkit-details-marker { display:none; }
.sum-left{ display:flex; gap:8px; align-items:center; }
.sum-right{ display:flex; gap:10px; align-items:center; }
.badge{ background:#eef3ff; color:#0e3a82; font-weight:700; padding:6px 10px; border-radius:999px; border:1px solid #dbe6ff; }
/* Botón Postular por OT */
.btn-ot{
 padding:8px 14px; border-radius:999px; border:none; cursor:pointer;
 background:#0e4aa8; color:#fff; font-size:13px; box-shadow:0 4px 12px rgba(14,74,168,.25);
}
.btn-ot:hover{ filter:brightness(.95); }
.btn-ot:disabled,
.btn-ot.disabled{ background:#d9e2f5; color:#6b7893; box-shadow:none; cursor:not-allowed; filter:none; }
/* Items (cards) */
.items{ display:grid; grid-template-columns: repeat(auto-fill, minmax(330px, 1fr)); gap:16px; margin-top:10px; }
.card{ background:#fff; border-radius:18px; padding:14px; box-shadow:0 8px 20px rgba(0,0,0,.07); border-bottom:3px solid #0e4aa8; }
.card label{ font-weight:600; color:#556; display:block; margin:6px 0 6px; }
.card input[readonly]{ background:#eef1f6; height:38px; width:100%; border-radius:12px; border:none; padding:0 12px; -webkit-user-drag:none; }
/* Textarea fijo */
.card textarea{ width:100%; height:64px; min-height:64px; max-height:64px; resize:none; overflow:auto;
 border:1px solid #cbd8ef; border-radius:12px; padding:10px 12px; line-height:1.25; -webkit-user-drag:none; }
.card textarea:focus{ outline:2px solid #0e4aa822; box-shadow: inset 0 0 0 1px #cbd8ef; }
/* Preview fotos */
.preview{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
.preview img{ width:78px; height:78px; border-radius:12px; object-fit:cover; box-shadow:0 4px 12px rgba(0,0,0,.2); }
/* Pie */
.pie{ width:92%; margin: 14px auto 24px; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
.paginacion{ display:flex; gap:6px; flex-wrap:wrap; }
.paginacion button{ padding:8px 12px; border-radius:10px; border:none; background:#0e4aa8; color:#fff; cursor:pointer; }
/* Alertas */
#alerta{ width:92%; margin:8px auto 0; color:#b00020; font-size:13px; display:none; }
</style>
</head>
<body>
<!-- HEADER -->
<div class="header">
 <div class="header-title">Exclusiones de Operatividad</div>
 <div class="header-sub"><strong>¡Bienvenido al modulo de exclusiones!</strong></div>
 <div class="controls">
  <button id="btnCargar" class="btn btn-blue" type="button">Cargar / Actualizar</button>
  <button id="btnLimpiar" class="btn btn-light" type="button">Limpiar</button>
  <div class="search-pill" title="Buscar por OT">
   <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20 15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
   </svg>
   <input id="busqueda" type="text" placeholder="Buscar OTs…" autocomplete="off" />
  </div>
  <span class="badge-ts" id="lastUpdate"><span class="badge-dot"></span>Última actualización: —</span>
 </div>
</div>
<!-- Contenedor -->
<div class="wrap" id="wrapGrupos"></div>
<!-- Pie -->
<div class="pie">
 <div class="info-res" id="infoRes">0 registros</div>
 <div class="paginacion" id="paginacion"></div>
</div>
<div id="alerta"></div>
<script>
/* ======================= CONFIG BACKEND (Cloudflare Workers) ======================= */
/* >>> PROYECTO p1: base con prefijo /p1 para todos los endpoints <<< */
const API_BASE = "https://exclusiones-worker.modulo-de-exclusiones.workers.dev/p1";

/* ======= Estado ======= */
let datos = [];
let filtrados = [];
let grupos = [];
let paginaActual = 1;
const porPaginaGrupos = 6;
const $ = sel => document.querySelector(sel);

/* ======= Utils ======= */
function mostrarAlerta(msg){ const el=$('#alerta'); el.textContent=msg; el.style.display='block'; }
function ocultarAlerta(){ const el=$('#alerta'); el.textContent=''; el.style.display='none'; }
function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }
function esc(s){ return (s??"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function cssId(texto){ return btoa(unescape(encodeURIComponent(texto))).replace(/=/g,''); }
function norm(s){ return (s ?? '').toString().trim(); }
function formatTs(d){ const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0');
 const yyyy=d.getFullYear(), hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0'), ss=String(d.getSeconds()).padStart(2,'0');
 return `${dd}/${mm}/${yyyy} ${hh}:${mi}:${ss}`; }
function setLastUpdate(dateObj){ const el=$('#lastUpdate'); if(el) el.innerHTML = `<span class="badge-dot"></span>Última actualización: ${formatTs(dateObj)}`; }

/* ======= Contador por OT ======= */
function contarCompletados(ot){
 const items = datos.filter(r => (r.ot??"").trim() === (ot??"").trim());
 const total = items.length;
 const completos = items.filter(r => (r.causa??"").trim() !== "").length;
 return { completos, total };
}

/* ======= Lectura desde Worker (CORS OK) ======= */
async function cargarDesdeServidor(){
 const btn=$('#btnCargar');
 try{
  ocultarAlerta(); btn.disabled=true; btn.textContent='Cargando…';
  // cache‑buster para evitar respuestas cacheadas en Pages
  const res = await fetch(`${API_BASE}/api/datos?ts=${Date.now()}`, { method:'GET', mode:'cors', headers:{'Accept':'application/json'} });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const j = await res.json();
  const arr = Array.isArray(j?.data) ? j.data : [];
  datos = arr.map((r,i)=>({
    id:i,
    fecha: r.fecha ?? '',
    ot : r.ot ?? '',
    causa: r.causa ?? '',
    fotos: []
  })).filter(x=>x.ot);
  filtrados=[...datos]; paginaActual=1; construirGruposPorOT(); render(); setLastUpdate(new Date());
 }catch(err){
  console.error(err); mostrarAlerta('No se pudo cargar el dataset del servidor.');
 }finally{
  btn.disabled=false; btn.textContent='Cargar / Actualizar';
 }
}

/* ======= Búsqueda / Grupo ======= */
function aplicarBusqueda(){
 const q=($('#busqueda').value??"").toLowerCase().trim();
 filtrados = q ? datos.filter(d => (d.ot??"").toLowerCase().includes(q)) : [...datos];
 paginaActual=1; construirGruposPorOT(); render();
}
function construirGruposPorOT(){
 const map=new Map();
 for(const r of filtrados){
  const k=(r.ot ?? '').toString().trim() || "—"; if(!map.has(k)) map.set(k, []); map.get(k).push(r);
 }
 grupos = Array.from(map.entries()).map(([k,items])=>({clave:k,items}));
 grupos.sort((a,b)=> a.clave.localeCompare(b.clave,'es',{numeric:true}));
}

/* ======= Estado del botón por OT ======= */
function isOTCompleta(ot){
 const items=datos.filter(d => (d.ot??"").toString().trim()===ot.toString().trim());
 if (!items.length) return false;
 return items.every(r => (r.causa??"").toString().trim() !== "" &&
                         (r.fecha??"").toString().trim() !== "");
}
function setBtnOTStateById(btnId, enabled){
 const btn=document.getElementById(btnId); if(!btn) return;
 btn.disabled=!enabled; btn.classList.toggle('disabled', !enabled);
}

/* ======= Render ======= */
function render(){
 const wrap=$('#wrapGrupos'); wrap.innerHTML="";
 const totalGrupos=grupos.length, totalItems=filtrados.length;
 $('#infoRes').textContent=`${totalItems} registros • ${totalGrupos} grupos (por OT)`;
 const ini=(paginaActual-1)*porPaginaGrupos, fin=ini+porPaginaGrupos, gruposPagina=grupos.slice(ini,fin);
 for(const g of gruposPagina){
  const otClave=g.clave; const det=document.createElement('details'); det.className="grupo"; // colapsado por defecto
  const conteo = contarCompletados(otClave);
  det.innerHTML=` 
  <summary>
   <div class="sum-left">OT: <strong>${esc(otClave)}</strong></div>
   <div class="sum-right">
    <span class="badge" id="badge_${cssId(otClave)}">${conteo.completos} de ${conteo.total} completados</span>
    <button id="btn_ot_${cssId(otClave)}" class="btn-ot" data-ot="${esc(otClave)}">Postular exclusiones</button>
   </div>
  </summary>
  <div class="items" id="items_${cssId(otClave)}"></div>`;
  wrap.appendChild(det);
  setBtnOTStateById(`btn_ot_${cssId(otClave)}`, isOTCompleta(otClave));
  const cont=det.querySelector(`#items_${cssId(otClave)}`);
  for(const item of g.items){
   const card=document.createElement('div'); card.className="card";
   card.innerHTML=`
   <label>Fecha</label><input value="${esc(item.fecha)}" readonly draggable="false">
   <label>OT</label><input value="${esc(item.ot)}" readonly draggable="false">
   <label style="margin-top:10px;">Causa</label>
   <textarea id="causa_${item.id}" draggable="false" placeholder="Motivo de exclusión…">${esc(item.causa??'')}</textarea>
   <label style="margin-top:10px;">Fotos</label>
   <input type="file" id="foto_${item.id}" multiple accept="image/*">
   <div class="preview" id="preview_${item.id}"></div>`;
   cont.appendChild(card);
   const txt = card.querySelector(`#causa_${item.id}`);
   txt.addEventListener('input', e=>{
     item.causa = e.target.value;
     const ref = datos.find(x=>x.id===item.id);
     if(ref) ref.causa = item.causa;
     setBtnOTStateById(`btn_ot_${cssId(otClave)}`, isOTCompleta(otClave));
     const sumBadge = document.getElementById(`badge_${cssId(otClave)}`);
     if(sumBadge){
       const c = contarCompletados(otClave);
       sumBadge.textContent = `${c.completos} de ${c.total} completados`;
     }
   });
   const prev = card.querySelector(`#preview_${item.id}`);
   const inp = card.querySelector(`#foto_${item.id}`);
   inp.addEventListener('change', e=>{
     const files = Array.from(e.target.files??[]);
     item.fotos = files; const ref=datos.find(x=>x.id===item.id); if(ref) ref.fotos=files;
     prev.innerHTML = "";
     for(const f of files){
       const img=document.createElement('img');
       img.src = URL.createObjectURL(f);
       prev.appendChild(img);
     }
   });
  }
 }
 renderPaginacion(totalGrupos);
}
function renderPaginacion(totalGrupos){
 const cont=$('#paginacion'); cont.innerHTML="";
 const total=Math.max(1, Math.ceil(totalGrupos/porPaginaGrupos));
 for(let i=1;i<=total;i++){
  const b=document.createElement('button'); b.textContent=i; if(i===paginaActual) b.style.opacity=.85;
  b.onclick=()=>{ paginaActual=i; render(); }; cont.appendChild(b);
 }
}

/* ======= Escritura: Worker (CORS OK) ======= */
async function postularPorOT(ot){
 const items = datos.filter(d => (d.ot??"").toString().trim() === (ot??"").toString().trim());
 if(!items.length){ alert(`No hay registros para la OT ${ot}`); return; }
 if(!isOTCompleta(ot)){ alert('Faltan causas o fecha en esta OT. Complétalas para habilitar el envío.'); return; }
 const registros = items.map(r => ({ fecha:r.fecha, ot:r.ot, causa:r.causa }));
 const btn = document.getElementById(`btn_ot_${cssId(ot)}`);
 btn.disabled = true; btn.textContent = 'Enviando…';
 try{
   const res = await fetch(`${API_BASE}/api/guardarOT`, {
     method:'POST',
     mode:'cors',
     headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
     body: JSON.stringify({ ot, registros })
   });
   const j = await res.json().catch(()=>null);
   if(j && j.ok){
     alert(`OT ${ot}: guardada correctamente. Actualizados: ${j.updated??0}, nuevos: ${j.appended??0}`);
     btn.textContent = 'OT postulada';
     btn.style.background = '#16a34a';
     btn.style.color = '#fff';
     btn.disabled = true;
     return;
   }else{
     throw new Error(j?.error || `HTTP ${res.status}`);
   }
 }catch(err){
   console.error(err);
   alert('Error de servidor: ' + err.message);
   btn.textContent = 'Postular exclusiones';
   setBtnOTStateById(`btn_ot_${cssId(ot)}`, isOTCompleta(ot));
 }
}

/* ======= Delegación de clic ======= */
$('#wrapGrupos').addEventListener('click', (e)=>{
 const btn = e.target.closest('.btn-ot'); if(!btn) return;
 e.preventDefault(); e.stopPropagation();
 const ot = btn.getAttribute('data-ot') ?? ''; if(ot) postularPorOT(ot);
});

/* ======= Acciones de UI ======= */
$('#btnCargar').addEventListener('click', cargarDesdeServidor);
$('#btnLimpiar').addEventListener('click', ()=>{
 $('#busqueda').value='';
 filtrados=[...datos]; paginaActual=1; construirGruposPorOT(); render();
});
$('#busqueda').addEventListener('input', debounce(aplicarBusqueda, 250));

/* ======= Arranque ======= */
cargarDesdeServidor();
</script>
</body>
</html>
